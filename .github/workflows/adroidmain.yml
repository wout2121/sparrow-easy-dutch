name: Build Android APK
on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Java 22
        uses: actions/setup-java@v4
        with:
          java-version: '22'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: false
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build with Gradle (APK Release)
        run: ./gradlew assembleRelease
      
      - name: Debug - List build directory
        run: |
          echo "=== Current working directory ==="
          pwd
          echo ""
          echo "=== Contents of build/ directory ==="
          ls -la build/ || echo "build/ directory not found"
          echo ""
          echo "=== Contents of app/build/outputs ==="
          ls -la app/build/outputs/ || echo "app/build/outputs not found"
          echo ""
          echo "=== Recursive build/ structure ==="
          ls -R build/ || echo "Cannot list build/"
          echo ""
          echo "=== Search for all APK files ==="
          find . -name "*.apk" -type f || echo "No APK files found"
          echo ""
          echo "=== Search for all AAB files ==="
          find . -name "*.aab" -type f || echo "No AAB files found"
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Sparrow-easy-dutch-Android-APK
          path: |
            app/build/outputs/apk/release/*.apk
            build/outputs/apk/release/*.apk
            **/build/outputs/apk/release/*.apk
          if-no-files-found: warn
